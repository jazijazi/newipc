CREATE OR REPLACE FUNCTION public.initialborders_filter(
    z integer,
    x integer,
    y integer,
    initialborderid integer,
    token text
)
RETURNS bytea
LANGUAGE plpgsql
COST 100
STABLE PARALLEL SAFE
AS $$
DECLARE
    pl_result bytea;
    pl_dyn_buffer integer;
    pl_border_dtypcode integer;
    pl_jwt_payload jsonb;
    pl_user_id integer;
    pl_has_access boolean := false;
    pl_is_superuser boolean := false;
BEGIN
    -- Require token
    IF token IS NULL OR token = '' THEN
        RAISE WARNING 'No JWT token provided for initialborderid %', initialborderid;
        RETURN '\x'::bytea;
    END IF;

    BEGIN
        -- Decode JWT payload
        pl_jwt_payload := decode_jwt_with_key(token)::jsonb;
        -- Extract user_id
        pl_user_id := (pl_jwt_payload->>'user_id')::integer;

    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'JWT validation failed for initialborderid %: %', initialborderid, SQLERRM;
            RETURN '\x'::bytea;
    END;

    -- Check superuser / permission
    BEGIN
        -- First, check if user is superuser
        SELECT COALESCE(u.is_superuser, false)
        INTO pl_is_superuser
        FROM public.accounts_user AS u
        WHERE u.id = pl_user_id;

        IF NOT pl_is_superuser THEN
            -- Permission check
            SELECT EXISTS(
                SELECT 1
                FROM public.accounts_userinitialborderpermission uibp
                WHERE uibp.user_id = pl_user_id
                AND uibp.initial_border_id = initialborderid
            )
            INTO pl_has_access;

            IF NOT pl_has_access THEN
                RAISE WARNING 'User % does not have access to initialborderid %', 
                    pl_user_id, initialborderid;
                RETURN '\x'::bytea;  -- Return empty tile instead of exception
            END IF;
        ELSE
            RAISE NOTICE 'User % is superuser, full access granted', pl_user_id;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Permission check failed: %', SQLERRM;
            RETURN '\x'::bytea;  -- Return empty tile on any error
    END;

    -- Calculate dynamic buffer based on zoom level
    pl_dyn_buffer := CASE
        WHEN z <= 8 THEN 1024
        WHEN z <= 12 THEN 512
        WHEN z <= 14 THEN 256
        ELSE 128
    END;

    -- Get the dtyp.code for this initialborderid
    SELECT dtyp.code
    INTO pl_border_dtypcode
    FROM public.initialborders_initialborder t
    JOIN public.initialborders_initialborderdomin dtyp ON dtyp.id = t.dtyp_id
    WHERE t.id = initialborderid;

    IF pl_border_dtypcode IS NULL THEN
        RAISE WARNING 'Border type code not found for initialborderid %', initialborderid;
        RETURN '\x'::bytea;
    END IF;

    -- Generate MVT based on border type
    IF pl_border_dtypcode = 404 THEN  -- Pahneh
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                pahneh.name as "نام",
                pahneh.masahat as "مساحت",
                pahneh.malekiyat as "مالکیت",
                pahneh.ostan as "استان",
                pahneh.shahrestan as "شهرستان"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadatapahneh pahneh ON pahneh.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSIF pl_border_dtypcode = 22 THEN  -- Darkhast Ekteshaf
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                dark.name as "نام ",
                dark.masahat as "مساحت",
                dark.malekiyat as "مالکیت",
                dark.ostan as "استان",
                dark.shahrestan as "شهرستان",
                dark.cadastre as "شماره کاداستر",
                dark.noemademadani as "نوع ماده معدنی",
                dark.organs as "ارگان های استعلام شونده"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadatadarkhastekteshaf dark ON dark.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSIF pl_border_dtypcode = 33 THEN  -- Parvaneh Ekteshaf
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                parv.name as "نام",
                parv.masahat as "مساحت",
                parv.malekiyat as "مالکیت",
                parv.ostan as "استان",
                parv.shahrestan as "شهرستان",
                parv.cadastre as "شماره کاداستر",
                parv.noemademadani as "نوع ماده معدنی",
                parv.shomareparvaneh as "شماره پروانه",
                parv.tarikhparvane as "تاریخ پروانه",
                parv.tarikhetebar as "تاریخ اعتبار"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadataparvaneekteshaf parv ON parv.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSIF pl_border_dtypcode = 44 THEN  -- Govahi Kashf
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                govah.name as "نام",
                govah.masahat as "مساحت",
                govah.malekiyat as "مالکیت",
                govah.ostan as "استان",
                govah.shahrestan as "شهرستان",
                govah.cadastre as "شماره کاداستر",
                govah.noemademadani as "نوع ماده معدنی",
                govah.shomareparvaneh as "شماره پروانه",
                govah.tarikhparvane as "تاریخ پروانه",
                govah.tarietebargovahi as "تاریخ اعتبار گواهی",
                govah.zakhireehtemali as "ذخیره احتمالی به تن",
                govah.zakhireghatei as "ذخیره قطعی به تن",
                govah.ayarehad as "عیار حد به درصد",
                govah.ayaremeyangin as "عیار میانگین به درصد",
                govah.shomaregovahikashf as "شماره گواهی کشف",
                govah.tarikhsodurgivahikashf as "تاریخ صدور گواهی کشف"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadatagovahikashf govah ON govah.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSIF pl_border_dtypcode = 55 THEN  -- Parvaneh Bahrebardari
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                bahre.name as "نام",
                bahre.masahat as "مساحت",
                bahre.malekiyat as "مالکیت",
                bahre.ostan as "استان",
                bahre.shahrestan as "شهرستان",
                bahre.cadastre as "شماره کاداستر",
                bahre.noemademadani as "نوع ماده معدنی",
                bahre.shomareparvaneh as "شماره پروانه",
                bahre.tarikhparvane as "تاریخ پروانه",
                bahre.tarietebarparvane as "تاریخ اعتبار پروانه",
                bahre.zakhireehtemali as "ذخیره احتمالی به تن",
                bahre.zakhireghatei as "ذخیره قطعی به تن",
                bahre.ayarehad as "عیار حد به درصد",
                bahre.ayaremeyangin as "عیار میانگین به درصد",
                bahre.estekhrajsaleyane as "استخراج سالیانه به تن"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadataparvanebahrebardai bahre ON bahre.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSIF pl_border_dtypcode = 303 THEN  -- Potansielyabi
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده",
                pot.name as "نام",
                pot.masahat as "مساحت",
                pot.malekiyat as "مالکیت",
                pot.ostan as "استان",
                pot.shahrestan as "شهرستان"
            FROM public.initialborders_initialborder t
            JOIN public.initialborders_initialbordermetadatapotansielyabi pot ON pot.rinitialborder_id = t.id
            CROSS JOIN bounds
            WHERE t.id = initialborderid
              AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;

    ELSE
        -- Default: just return the border geometry without metadata
        WITH bounds AS (
            SELECT ST_TileEnvelope(z, x, y) AS geom
        ),
        mvtgeom AS (
            SELECT 
                ST_AsMVTGeom(ST_Transform(t.border, 3857), bounds.geom, 4096, pl_dyn_buffer, true) AS geom,
                t.id,
                t.dtyp_id,
                t.title as "عنوان محدوده"
            FROM public.initialborders_initialborder t
            CROSS JOIN bounds
            WHERE t.id = initialborderid
            AND ST_Intersects(t.border, ST_Transform(bounds.geom, 4326))
        )
        SELECT ST_AsMVT(mvtgeom, 'default') INTO pl_result FROM mvtgeom;
    END IF;

    IF pl_result IS NULL THEN
        RETURN '\x'::bytea;
    END IF;

    RETURN pl_result;

EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING
            'Error in initialborders_filter: %, InitialBorder ID: %, User ID: %',
            SQLERRM, initialborderid, pl_user_id;
        RETURN '\x'::bytea;
END;
$$;